# Database Migrations Guide

## Overview
This project uses Supabase migrations as the single source of truth for database schema changes. All database modifications should be made through migrations, not ad-hoc SQL.

## Migration Files
All migrations are stored in `./supabase/migrations/` and are automatically applied in chronological order based on their timestamp prefix.

## Creating New Migrations

### 1. Using Supabase CLI (Recommended)
```bash
# Create a new migration
supabase migration new add_new_table

# This creates a file like: 20240101120000_add_new_table.sql
```

### 2. Manual Creation
Create a new file in `./supabase/migrations/` with the format:
```
YYYYMMDDHHMMSS_descriptive_name.sql
```

## Migration Best Practices

### 1. Always Include RLS Policies
When creating tables, always include appropriate Row Level Security policies:

```sql
-- Create table
CREATE TABLE public.example (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users on delete cascade,
  data text,
  created_at timestamptz default now()
);

-- Enable RLS
ALTER TABLE public.example ENABLE ROW LEVEL SECURITY;

-- Add policies
CREATE POLICY "users can read example" ON public.example
  FOR SELECT USING (true);

CREATE POLICY "users can CRUD their own example" ON public.example
  FOR ALL USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);
```

### 2. Include Indexes for Performance
Add indexes for frequently queried columns:

```sql
-- Add index for foreign keys
CREATE INDEX idx_example_user_id ON public.example(user_id);

-- Add index for search columns
CREATE INDEX idx_example_data ON public.example USING gin(to_tsvector('english', data));
```

### 3. Use Transactions for Complex Changes
Wrap complex migrations in transactions:

```sql
BEGIN;

-- Multiple related changes
CREATE TABLE public.new_table (...);
ALTER TABLE public.existing_table ADD COLUMN new_column text;
CREATE INDEX idx_new_table_column ON public.new_table(column);

COMMIT;
```

## Running Migrations

### Local Development
```bash
# Apply all pending migrations
supabase db push

# Reset database and apply all migrations + seed data
supabase db reset
```

### CI/CD
Migrations are automatically applied in CI when:
- PR checks run
- Preview databases are created
- Production deployments occur

## Rollback Strategy

### For Development
```bash
# Reset to clean state
supabase db reset
```

### For Production
Create a new migration that reverses the changes:

```sql
-- Example rollback migration
DROP TABLE IF EXISTS public.example;
DROP INDEX IF EXISTS idx_example_user_id;
```

## Schema Changes Checklist

Before creating a migration, ensure:

- [ ] Table/column names follow naming conventions
- [ ] Appropriate data types are used
- [ ] Foreign key constraints are defined
- [ ] RLS policies are created
- [ ] Indexes are added for performance
- [ ] Migration is tested locally
- [ ] Rollback strategy is considered

## Common Patterns

### Adding a New Table
```sql
-- 1. Create table with proper constraints
-- 2. Enable RLS
-- 3. Add policies
-- 4. Add indexes
-- 5. Add comments for documentation
```

### Modifying Existing Tables
```sql
-- 1. Add new columns with defaults
-- 2. Update existing data if needed
-- 3. Add constraints
-- 4. Add indexes for new columns
```

### Adding RLS Policies
```sql
-- Always test policies with different user contexts
-- Use EXPLAIN to verify policy effectiveness
-- Consider performance impact of complex policies
```

## Troubleshooting

### Migration Fails
1. Check the migration file syntax
2. Verify dependencies (tables, functions, etc.)
3. Test locally with `supabase db reset`
4. Check Supabase logs for detailed error messages

### Performance Issues
1. Review query plans with `EXPLAIN`
2. Add missing indexes
3. Consider materialized views for complex queries
4. Optimize RLS policies

## Resources
- [Supabase Migrations Documentation](https://supabase.com/docs/guides/database/migrations)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Row Level Security Guide](https://supabase.com/docs/guides/auth/row-level-security)
